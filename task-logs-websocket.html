<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡æ—¥å¿— WebSocket æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            margin: 20px;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #569cd6;
            text-align: center;
        }
        .control-panel {
            background-color: #252526;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: inline-block;
            width: 100px;
            color: #9cdcfe;
            font-weight: bold;
        }
        input[type="text"], select {
            width: 600px;
            padding: 8px;
            background-color: #3c3c3c;
            border: 1px solid #555;
            color: #cccccc;
            border-radius: 4px;
            font-family: inherit;
        }
        button {
            background-color: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        button:hover {
            background-color: #1177bb;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.connected {
            background-color: #4ec9b0;
            color: #1e1e1e;
        }
        .status.disconnected {
            background-color: #f44747;
            color: white;
        }
        .log-container {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            height: 600px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .log-entry:hover {
            background-color: #2a2d2e;
        }
        .log-entry.info {
            color: #4ec9b0;
            border-left: 3px solid #4ec9b0;
        }
        .log-entry.error {
            color: #f44747;
            background-color: rgba(244, 71, 71, 0.1);
            border-left: 3px solid #f44747;
        }
        .log-entry.success {
            color: #89d185;
            border-left: 3px solid #89d185;
        }
        .log-entry.warning {
            color: #ce9178;
            border-left: 3px solid #ce9178;
        }
        .log-entry.command {
            color: #dcdcaa;
            background-color: #264f78;
            border-left: 3px solid #569cd6;
            font-family: 'Consolas', monospace;
        }
        .log-entry.output {
            color: #cccccc;
            background-color: #1e1e1e;
            margin-left: 20px;
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
        }
        .timestamp {
            color: #858585;
            margin-right: 10px;
        }
        .task-info {
            background-color: #264f78;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        .task-info h3 {
            margin: 0 0 10px 0;
            color: #569cd6;
        }
        .task-info .info-item {
            margin: 5px 0;
            color: #cccccc;
        }
        .task-info .info-label {
            color: #9cdcfe;
            font-weight: bold;
            display: inline-block;
            width: 100px;
        }
        .clear-button {
            float: right;
            background-color: #555;
        }
        .clear-button:hover {
            background-color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ä»»åŠ¡æ—¥å¿— WebSocket æµ‹è¯•å·¥å…·</h1>
        
        <div class="control-panel">
            <h2>è¿æ¥é…ç½®</h2>
            
            <div class="form-group">
                <label>æœåŠ¡å™¨åœ°å€:</label>
                <input type="text" id="serverUrl" value="ws://192.168.31.66:8080/api/v1/ws/tasks" />
            </div>
            
            <div class="form-group">
                <label>Token:</label>
                <input type="text" id="token" placeholder="è¯·å…ˆç™»å½•è·å–Token" />
                <button onclick="loginAndGetToken()">ğŸ”‘ ç™»å½•è·å–Token</button>
            </div>
            
            <div class="form-group">
                <label>ä»»åŠ¡ID:</label>
                <input type="text" id="taskId" placeholder="è¾“å…¥ä»»åŠ¡IDæˆ–åˆ›å»ºæ–°ä»»åŠ¡" />
                <button onclick="createNewTask()">â• åˆ›å»ºæµ‹è¯•ä»»åŠ¡</button>
                <button onclick="createPingTask()">ğŸ“Œ åˆ›å»º Ping ä»»åŠ¡</button>
                <button onclick="getTaskList()">ğŸ“‹ è·å–ä»»åŠ¡åˆ—è¡¨</button>
            </div>
            
            <div>
                <button onclick="connectWebSocket()" id="connectBtn">ğŸ”Œ è¿æ¥ WebSocket</button>
                <button onclick="disconnectWebSocket()" id="disconnectBtn" disabled>ğŸ”Œ æ–­å¼€è¿æ¥</button>
                <button onclick="testEndpoint()">ğŸ§ª æµ‹è¯•ç«¯ç‚¹</button>
                <button onclick="clearLogs()" class="clear-button">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                <span class="status disconnected" id="status">æœªè¿æ¥</span>
            </div>
        </div>

        <div class="task-info" id="taskInfo">
            <h3>ğŸ“Š ä»»åŠ¡ä¿¡æ¯</h3>
            <div class="info-item">
                <span class="info-label">ä»»åŠ¡ID:</span>
                <span id="taskIdInfo">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">ä»»åŠ¡ç±»å‹:</span>
                <span id="taskType">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">ä»»åŠ¡çŠ¶æ€:</span>
                <span id="taskStatus">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç›®æ ‡ä¸»æœº:</span>
                <span id="taskHosts">-</span>
            </div>
        </div>

        <h2>ğŸ“œ å®æ—¶æ—¥å¿—</h2>
        <div class="log-container" id="logContainer"></div>
    </div>

    <script>
        let ws = null;
        let reconnectInterval = null;
        
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            entry.innerHTML = `<span class="timestamp">${timestamp}</span> ${message}`;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function loginAndGetToken() {
            log('æ­£åœ¨ç™»å½•è·å–Token...', 'info');
            
            try {
                const response = await fetch('http://192.168.31.66:8080/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'Admin@123'
                    })
                });

                const data = await response.json();
                if (data.code === 200) {
                    document.getElementById('token').value = data.data.token;
                    log('âœ… æˆåŠŸè·å–Token!', 'success');
                } else {
                    log(`âŒ ç™»å½•å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (e) {
                log(`âŒ ç™»å½•è¯·æ±‚å¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function createNewTask() {
            const token = document.getElementById('token').value;
            if (!token) {
                log('âŒ è¯·å…ˆè·å–Token', 'error');
                return;
            }

            log('æ­£åœ¨åˆ›å»ºæµ‹è¯•ä»»åŠ¡...', 'info');
            
            try {
                const response = await fetch('http://192.168.31.66:8080/api/v1/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        task_type: "collect",
                        name: `æµ‹è¯•ä»»åŠ¡ ${new Date().toLocaleString()}`,
                        priority: 5,
                        timeout: 60,
                        description: "æ”¶é›†ç³»ç»Ÿä¿¡æ¯æµ‹è¯•ä»»åŠ¡",
                        hosts: [2, 1]
                    })
                });

                const data = await response.json();
                if (data.code === 200) {
                    document.getElementById('taskId').value = data.data.task_id;
                    log(`âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸ! ID: ${data.data.task_id}`, 'success');
                    
                    // æ˜¾ç¤ºä»»åŠ¡ä¿¡æ¯
                    showTaskInfo(data.data);
                    
                    // è‡ªåŠ¨è¿æ¥WebSocket
                    setTimeout(() => {
                        log('è‡ªåŠ¨è¿æ¥WebSocketæŸ¥çœ‹æ—¥å¿—...', 'info');
                        connectWebSocket();
                    }, 500);
                } else {
                    log(`âŒ åˆ›å»ºä»»åŠ¡å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (e) {
                log(`âŒ åˆ›å»ºä»»åŠ¡è¯·æ±‚å¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function createPingTask() {
            const token = document.getElementById('token').value;
            if (!token) {
                log('âŒ è¯·å…ˆè·å–Token', 'error');
                return;
            }

            log('æ­£åœ¨åˆ›å»ºPingä»»åŠ¡...', 'info');
            
            try {
                const response = await fetch('http://192.168.31.66:8080/api/v1/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        task_type: "ping",
                        name: "æµ‹è¯•ä¸»æœºè¿é€šæ€§",
                        priority: 5,
                        timeout: 60,
                        description: "æ£€æŸ¥æ–°æ·»åŠ ä¸»æœºçš„ç½‘ç»œè¿é€šæ€§",
                        hosts: [2, 1]
                    })
                });

                const data = await response.json();
                if (data.code === 200) {
                    document.getElementById('taskId').value = data.data.task_id;
                    log(`âœ… Pingä»»åŠ¡åˆ›å»ºæˆåŠŸ! ID: ${data.data.task_id}`, 'success');
                    
                    // æ˜¾ç¤ºä»»åŠ¡ä¿¡æ¯
                    showTaskInfo(data.data);
                    
                    // è‡ªåŠ¨è¿æ¥WebSocket
                    setTimeout(() => {
                        log('è‡ªåŠ¨è¿æ¥WebSocketæŸ¥çœ‹æ—¥å¿—...', 'info');
                        connectWebSocket();
                    }, 500);
                } else {
                    log(`âŒ åˆ›å»ºPingä»»åŠ¡å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (e) {
                log(`âŒ åˆ›å»ºPingä»»åŠ¡è¯·æ±‚å¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function getTaskList() {
            const token = document.getElementById('token').value;
            if (!token) {
                log('âŒ è¯·å…ˆè·å–Token', 'error');
                return;
            }

            log('æ­£åœ¨è·å–ä»»åŠ¡åˆ—è¡¨...', 'info');
            
            try {
                const response = await fetch('http://192.168.31.66:8080/api/v1/tasks?page=1&page_size=10', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (data.code === 200) {
                    log(`âœ… è·å–åˆ° ${data.data.length} ä¸ªä»»åŠ¡:`, 'success');
                    data.data.forEach(task => {
                        log(`  ğŸ“ TaskID: ${task.task_id} | ${task.name} | çŠ¶æ€: ${task.status} | ç±»å‹: ${task.task_type}`, 'info');
                    });
                    
                    if (data.data.length > 0) {
                        log('ğŸ’¡ æç¤º: å¤åˆ¶TaskIDåˆ°è¾“å…¥æ¡†ä¸­å¯ä»¥æŸ¥çœ‹æ—¥å¿—', 'warning');
                    }
                } else {
                    log(`âŒ è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (e) {
                log(`âŒ è·å–ä»»åŠ¡åˆ—è¡¨è¯·æ±‚å¤±è´¥: ${e.message}`, 'error');
            }
        }

        function showTaskInfo(task) {
            document.getElementById('taskInfo').style.display = 'block';
            document.getElementById('taskIdInfo').textContent = task.task_id;
            document.getElementById('taskType').textContent = task.task_type || task.type;
            document.getElementById('taskStatus').textContent = task.status;
            document.getElementById('taskHosts').textContent = task.hosts ? task.hosts.join(', ') : '-';
        }

        function connectWebSocket() {
            const token = document.getElementById('token').value;
            const taskId = document.getElementById('taskId').value;
            
            if (!token) {
                log('âŒ è¯·å…ˆè¾“å…¥Token', 'error');
                return;
            }
            
            if (!taskId) {
                log('âŒ è¯·å…ˆè¾“å…¥ä»»åŠ¡ID', 'error');
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                log('âš ï¸ WebSocketå·²ç»è¿æ¥', 'warning');
                return;
            }

            const wsUrl = `${document.getElementById('serverUrl').value}/${taskId}/logs?token=${encodeURIComponent(token)}`;
            log(`ğŸ”— æ­£åœ¨è¿æ¥: ${wsUrl}`, 'info');

            ws = new WebSocket(wsUrl);

            ws.onopen = function(event) {
                log('âœ… WebSocketè¿æ¥æˆåŠŸ!', 'success');
                updateConnectionStatus(true);
                log('ç­‰å¾…æ¥æ”¶ä»»åŠ¡æ—¥å¿—...', 'info');
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    // æ ¹æ®æ—¥å¿—ç±»å‹æ˜¾ç¤ºä¸åŒæ ·å¼
                    if (data.level === 'command') {
                        log(`$ ${data.message}`, 'command');
                    } else if (data.level === 'output') {
                        log(data.message, 'output');
                    } else if (data.level === 'error' || data.source === 'ansible-stderr') {
                        log(`âŒ ${data.message}`, 'error');
                    } else if (data.level === 'info') {
                        log(`â„¹ï¸ ${data.message}`, 'info');
                    } else if (data.level === 'success') {
                        log(`âœ… ${data.message}`, 'success');
                    } else if (data.level === 'warning') {
                        log(`âš ï¸ ${data.message}`, 'warning');
                    } else {
                        // é»˜è®¤è¾“å‡º
                        log(data.message || JSON.stringify(data), 'info');
                    }
                    
                    // å¦‚æœä»»åŠ¡å®Œæˆæˆ–å¤±è´¥ï¼Œæ›´æ–°çŠ¶æ€
                    if (data.task_status) {
                        document.getElementById('taskStatus').textContent = data.task_status;
                        if (data.task_status === 'completed') {
                            log('ğŸ‰ ä»»åŠ¡æ‰§è¡Œå®Œæˆ!', 'success');
                        } else if (data.task_status === 'failed') {
                            log('âŒ ä»»åŠ¡æ‰§è¡Œå¤±è´¥!', 'error');
                        }
                    }
                } catch (e) {
                    // å¦‚æœä¸æ˜¯JSONï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹æ¶ˆæ¯
                    log(event.data, 'info');
                }
            };

            ws.onerror = function(error) {
                log(`âŒ WebSocketé”™è¯¯: ${error}`, 'error');
                console.error('WebSocketé”™è¯¯è¯¦æƒ…:', error);
            };

            ws.onclose = function(event) {
                log(`ğŸ”Œ è¿æ¥å…³é—­ - ä»£ç : ${event.code}, åŸå› : ${event.reason || 'æœªçŸ¥'}`, 'warning');
                updateConnectionStatus(false);
                
                if (event.code === 1006) {
                    log('ğŸ’¡ æç¤º: è¿æ¥å¼‚å¸¸å…³é—­ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–ä»»åŠ¡å·²ç»“æŸ', 'warning');
                }
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
                log('ğŸ‘‹ ä¸»åŠ¨æ–­å¼€è¿æ¥', 'info');
            }
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                status.textContent = 'å·²è¿æ¥';
                status.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                status.textContent = 'æœªè¿æ¥';
                status.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…é™¤', 'info');
        }
        
        async function testEndpoint() {
            const token = document.getElementById('token').value;
            const taskId = document.getElementById('taskId').value;
            
            if (!token || !taskId) {
                log('âŒ è¯·å…ˆè¾“å…¥Tokenå’Œä»»åŠ¡ID', 'error');
                return;
            }
            
            log('ğŸ§ª å¼€å§‹æµ‹è¯•WebSocketç«¯ç‚¹...', 'info');
            
            // æµ‹è¯•HTTPç«¯ç‚¹
            const httpUrl = `http://192.168.31.66:8080/api/v1/ws/tasks/${taskId}/logs?token=${encodeURIComponent(token)}`;
            
            try {
                const response = await fetch(httpUrl, {
                    method: 'GET',
                    headers: {
                        'Connection': 'Upgrade',
                        'Upgrade': 'websocket',
                        'Sec-WebSocket-Version': '13',
                        'Sec-WebSocket-Key': 'x3JJHMbDL1EzLkh9GBhXDw=='
                    }
                });
                
                log(`HTTPæµ‹è¯•å“åº”: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'warning');
                
                const text = await response.text();
                if (text) {
                    try {
                        const json = JSON.parse(text);
                        log(`å“åº”å†…å®¹: ${JSON.stringify(json, null, 2)}`, 'info');
                    } catch {
                        log(`å“åº”æ–‡æœ¬: ${text}`, 'info');
                    }
                }
                
                // å¦‚æœè¿”å›401ï¼Œè¯´æ˜è·¯ç”±å­˜åœ¨ä½†è®¤è¯å¤±è´¥
                if (response.status === 401) {
                    log('âœ… WebSocketè·¯ç”±å­˜åœ¨ï¼Œä½†Tokenè®¤è¯å¤±è´¥', 'warning');
                    log('è¯·ç¡®ä¿Tokenæœ‰æ•ˆå¹¶ä¸”ä»»åŠ¡å­˜åœ¨', 'warning');
                } else if (response.status === 404) {
                    log('âŒ WebSocketè·¯ç”±ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡ç«¯è·¯ç”±é…ç½®', 'error');
                } else if (response.status === 400) {
                    log('âš ï¸ è¯·æ±‚æ ¼å¼é”™è¯¯ï¼Œå¯èƒ½æ˜¯å‚æ•°é—®é¢˜', 'warning');
                }
                
            } catch (e) {
                log(`âŒ æµ‹è¯•è¯·æ±‚å¤±è´¥: ${e.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('ğŸš€ ä»»åŠ¡æ—¥å¿—WebSocketæµ‹è¯•å·¥å…·å·²å°±ç»ª', 'info');
            log('è¯·å…ˆç™»å½•è·å–Tokenï¼Œç„¶åè¾“å…¥ä»»åŠ¡IDæˆ–åˆ›å»ºæ–°ä»»åŠ¡', 'info');
        };

        // é¡µé¢å…³é—­æ—¶æ–­å¼€è¿æ¥
        window.onbeforeunload = function() {
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html>