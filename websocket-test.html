<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AHOP WebSocket ç½‘ç»œæ‰«ææµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        .log-entry.info {
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
        }
        .log-entry.success {
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
        }
        .log-entry.error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
        }
        .log-entry.warning {
            background-color: #fff8e1;
            border-left: 4px solid #ff9800;
        }
        .log-entry.progress {
            background-color: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        .timestamp {
            color: #666;
            font-size: 11px;
        }
        .quick-fill {
            margin-top: 10px;
        }
        .quick-fill button {
            font-size: 12px;
            padding: 5px 10px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s ease;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” AHOP WebSocket ç½‘ç»œæ‰«ææµ‹è¯•</h1>
        
        <div class="status disconnected" id="status">
            çŠ¶æ€ï¼šæœªè¿æ¥
        </div>

        <div class="form-group">
            <label for="wsUrl">WebSocket URL:</label>
            <input type="text" id="wsUrl" value="ws://192.168.31.66:8080/api/v1/ws/network-scan/" placeholder="ws://192.168.31.66:8080/api/v1/ws/network-scan/">
        </div>

        <div class="form-group">
            <label for="scanId">æ‰«æä»»åŠ¡ ID:</label>
            <input type="text" id="scanId" placeholder="ä¾‹å¦‚: 5d41204a-883b-40d0-965f-ffe191c740a5">
            <div class="quick-fill">
                <button class="btn-warning" onclick="createNewScan()">åˆ›å»ºæ–°æ‰«æä»»åŠ¡</button>
            </div>
        </div>

        <div class="form-group">
            <label for="token">JWT Token:</label>
            <textarea id="token" placeholder="è¯·è¾“å…¥ä½ çš„JWT Token"></textarea>
            <div class="quick-fill">
                <button class="btn-warning" onclick="loginAndGetToken()">ç™»å½•è·å–Token</button>
            </div>
        </div>

        <div class="form-group" id="scanConfig" style="display:none;">
            <label>æ‰«æé…ç½®:</label>
            <input type="text" id="networks" placeholder="ç½‘æ®µ (ä¾‹å¦‚: 192.168.31.1/30)" value="192.168.31.1/30">
            <div style="margin-top: 10px;">
                <label><input type="checkbox" id="methodPing" checked> PING</label>
                <label><input type="checkbox" id="methodTcp"> TCP</label>
                <label><input type="checkbox" id="methodUdp"> UDP</label>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-primary" onclick="connectWebSocket()">è¿æ¥ WebSocket</button>
            <button class="btn-danger" onclick="disconnectWebSocket()">æ–­å¼€è¿æ¥</button>
            <button class="btn-success" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        </div>

        <div class="progress-bar" id="progressBar" style="display:none;">
            <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
        </div>

        <h3>ğŸ“‹ æ¶ˆæ¯æ—¥å¿—</h3>
        <div class="log-container" id="logContainer">
            <div class="log-entry info">
                <span class="timestamp">${new Date().toLocaleTimeString()}</span> - ç­‰å¾…è¿æ¥...
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentScanId = null;

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="timestamp">${timestamp}</span> - ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(status, text) {
            const statusElement = document.getElementById('status');
            statusElement.className = `status ${status}`;
            statusElement.textContent = text;
        }

        function connectWebSocket() {
            const wsUrl = document.getElementById('wsUrl').value;
            const scanId = document.getElementById('scanId').value;
            const token = document.getElementById('token').value;

            if (!scanId) {
                log('âŒ è¯·è¾“å…¥æ‰«æä»»åŠ¡ID', 'error');
                return;
            }

            if (!token) {
                log('âŒ è¯·è¾“å…¥JWT Token', 'error');
                return;
            }

            const fullUrl = `${wsUrl}${scanId}?token=${token}`;
            log(`æ­£åœ¨è¿æ¥: ${wsUrl}${scanId}`, 'info');
            updateStatus('connecting', 'çŠ¶æ€ï¼šè¿æ¥ä¸­...');

            try {
                ws = new WebSocket(fullUrl);
                
                ws.onopen = function() {
                    log('âœ… WebSocketè¿æ¥æˆåŠŸï¼', 'success');
                    updateStatus('connected', 'çŠ¶æ€ï¼šå·²è¿æ¥');
                    document.getElementById('progressBar').style.display = 'block';
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data, null, 2)}`, 'info');
                        
                        if (data.type === 'progress') {
                            handleProgressMessage(data.data);
                        } else if (data.type === 'result') {
                            handleResultMessage(data.data);
                        } else if (data.type === 'complete') {
                            handleCompleteMessage(data.data);
                        } else if (data.type === 'status') {
                            handleStatusMessage(data.data);
                        }
                    } catch (e) {
                        log(`è§£ææ¶ˆæ¯å¤±è´¥: ${e.message}`, 'error');
                    }
                };

                ws.onerror = function(error) {
                    log(`âŒ WebSocketé”™è¯¯: ${error}`, 'error');
                    updateStatus('disconnected', 'çŠ¶æ€ï¼šè¿æ¥é”™è¯¯');
                };

                ws.onclose = function(event) {
                    log(`ğŸ”Œ è¿æ¥å…³é—­ - ä»£ç : ${event.code}, åŸå› : ${event.reason || 'æœªçŸ¥'}`, 'warning');
                    updateStatus('disconnected', 'çŠ¶æ€ï¼šå·²æ–­å¼€');
                    ws = null;
                };

            } catch (e) {
                log(`âŒ åˆ›å»ºWebSocketå¤±è´¥: ${e.message}`, 'error');
                updateStatus('disconnected', 'çŠ¶æ€ï¼šè¿æ¥å¤±è´¥');
            }
        }

        function handleProgressMessage(data) {
            log(`ğŸ“Š è¿›åº¦: ${data.progress}% - ${data.message} (å·²æ‰«æ: ${data.scanned}/${data.total}, å‘ç°: ${data.found})`, 'progress');
            updateProgressBar(data.progress);
        }

        function handleResultMessage(data) {
            log(`ğŸ” å‘ç°å­˜æ´»ä¸»æœº: ${data.ip}`, 'success');
            if (data.results) {
                data.results.forEach(result => {
                    log(`  - åè®®: ${result.protocol}, çŠ¶æ€: ${result.status}, å“åº”æ—¶é—´: ${result.rtt}`, 'info');
                });
            }
        }

        function handleCompleteMessage(data) {
            log(`âœ… æ‰«æå®Œæˆ! å…±å‘ç° ${data.total_found} ä¸ªå­˜æ´»ä¸»æœº, è€—æ—¶: ${data.duration}`, 'success');
            updateProgressBar(100);
        }

        function handleStatusMessage(data) {
            log(`ğŸ“‹ ä»»åŠ¡çŠ¶æ€: ${data.status}, è¿›åº¦: ${data.progress}%, å·²å‘ç°: ${data.results} ä¸ªç»“æœ`, 'info');
        }

        function updateProgressBar(progress) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = progress + '%';
            progressFill.textContent = progress + '%';
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                log('æ­£åœ¨æ–­å¼€è¿æ¥...', 'warning');
            } else {
                log('å½“å‰æ²¡æœ‰æ´»åŠ¨çš„WebSocketè¿æ¥', 'warning');
            }
        }

        function clearLogs() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';
            log('æ—¥å¿—å·²æ¸…é™¤', 'info');
        }

        async function loginAndGetToken() {
            log('æ­£åœ¨ç™»å½•è·å–Token...', 'info');
            
            try {
                const url = 'http://192.168.31.66:8080/api/v1/auth/login';
                log(`æ­£åœ¨å‘é€è¯·æ±‚åˆ°: ${url}`, 'info');
                
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'Admin@123'
                    })
                });

                log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'info' : 'error');
                
                if (!response.ok) {
                    const text = await response.text();
                    log(`å“åº”å†…å®¹: ${text}`, 'error');
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.code === 200) {
                    document.getElementById('token').value = data.data.token;
                    log('âœ… æˆåŠŸè·å–Token!', 'success');
                } else {
                    log(`âŒ ç™»å½•å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (e) {
                log(`âŒ ç™»å½•è¯·æ±‚å¤±è´¥: ${e.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', e);
            }
        }

        async function createNewScan() {
            const token = document.getElementById('token').value;
            if (!token) {
                log('âŒ è¯·å…ˆè·å–Token', 'error');
                return;
            }

            document.getElementById('scanConfig').style.display = 'block';
            log('æ­£åœ¨åˆ›å»ºæ–°çš„æ‰«æä»»åŠ¡...', 'info');

            const methods = [];
            if (document.getElementById('methodPing').checked) methods.push('ping');
            if (document.getElementById('methodTcp').checked) methods.push('tcp');
            if (document.getElementById('methodUdp').checked) methods.push('udp');

            const networks = document.getElementById('networks').value.split(',').map(n => n.trim());

            try {
                const url = 'http://192.168.31.66:8080/api/v1/network-scan/start';
                log(`æ­£åœ¨å‘é€è¯·æ±‚åˆ°: ${url}`, 'info');
                
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        networks: networks,
                        methods: methods,
                        timeout: 5,
                        concurrency: 3,
                        ports: [22, 80, 443]
                    })
                });

                log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'info' : 'error');
                
                if (!response.ok) {
                    const text = await response.text();
                    log(`å“åº”å†…å®¹: ${text}`, 'error');
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.code === 200) {
                    document.getElementById('scanId').value = data.data.scan_id;
                    currentScanId = data.data.scan_id;
                    log(`âœ… æ‰«æä»»åŠ¡åˆ›å»ºæˆåŠŸ! ID: ${data.data.scan_id}`, 'success');
                    
                    // è‡ªåŠ¨è¿æ¥WebSocket
                    setTimeout(() => {
                        log('è‡ªåŠ¨è¿æ¥WebSocket...', 'info');
                        connectWebSocket();
                    }, 500);
                } else {
                    log(`âŒ åˆ›å»ºæ‰«æå¤±è´¥: ${data.message}`, 'error');
                }
            } catch (e) {
                log(`âŒ åˆ›å»ºæ‰«æè¯·æ±‚å¤±è´¥: ${e.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', e);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¡«å……ä¸€äº›æµ‹è¯•æ•°æ®
        window.onload = function() {
            // å¦‚æœURLä¸­æœ‰å‚æ•°ï¼Œè‡ªåŠ¨å¡«å……
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('scanId')) {
                document.getElementById('scanId').value = urlParams.get('scanId');
            }
            if (urlParams.get('token')) {
                document.getElementById('token').value = urlParams.get('token');
            }
        };
    </script>
</body>
</html>