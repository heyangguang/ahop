<!DOCTYPE html>
<html>
<head>
    <title>WebSocket实时日志测试</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
        #logs {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
            margin-top: 10px;
        }
        .log-entry {
            margin: 2px 0;
            white-space: pre-wrap;
        }
        .error {
            color: #f44336;
        }
        .info {
            color: #2196F3;
        }
        .success {
            color: #4CAF50;
        }
        input[type="text"] {
            background-color: #2d2d2d;
            color: #d4d4d4;
            border: 1px solid #555;
            padding: 5px;
            width: 400px;
            margin: 5px;
        }
        button {
            background-color: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #1177bb;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>WebSocket实时日志测试</h1>
    
    <div>
        <label>JWT Token:</label><br>
        <input type="text" id="token" placeholder="输入JWT Token" value="">
    </div>
    
    <div>
        <label>任务ID:</label><br>
        <input type="text" id="taskId" placeholder="输入任务ID" value="">
    </div>
    
    <div>
        <button id="connectBtn" onclick="connect()">连接</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>断开</button>
        <button onclick="clearLogs()">清空日志</button>
    </div>
    
    <div id="status"></div>
    
    <div id="logs"></div>
    
    <script>
        let ws = null;
        let reconnectInterval = null;
        
        function log(message, type = '') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }
        
        function setStatus(status, type = 'info') {
            document.getElementById('status').innerHTML = `<span class="${type}">${status}</span>`;
        }
        
        function connect() {
            const token = document.getElementById('token').value.trim();
            const taskId = document.getElementById('taskId').value.trim();
            
            if (!token) {
                alert('请输入JWT Token');
                return;
            }
            
            if (!taskId) {
                alert('请输入任务ID');
                return;
            }
            
            log('正在连接WebSocket...', 'info');
            setStatus('连接中...', 'info');
            
            // 构建WebSocket URL，使用查询参数传递token
            const wsUrl = `ws://localhost:8080/api/v1/ws/tasks/${taskId}/logs?token=${encodeURIComponent(token)}`;
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    log('WebSocket连接成功', 'success');
                    setStatus('已连接', 'success');
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'log') {
                            log(`[${data.level}] ${data.message}`, data.level === 'error' ? 'error' : '');
                        } else if (data.type === 'progress') {
                            log(`进度更新: ${data.progress}%`, 'info');
                        } else if (data.type === 'status') {
                            log(`状态更新: ${data.status}`, 'info');
                        } else {
                            log('收到消息: ' + event.data);
                        }
                    } catch (e) {
                        // 如果不是JSON格式，直接显示
                        log('收到消息: ' + event.data);
                    }
                };
                
                ws.onerror = function(error) {
                    log('WebSocket错误: ' + error, 'error');
                    setStatus('连接错误', 'error');
                };
                
                ws.onclose = function(event) {
                    log(`WebSocket连接关闭 (code: ${event.code}, reason: ${event.reason})`, 'error');
                    setStatus('已断开', 'error');
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    ws = null;
                };
                
            } catch (error) {
                log('创建WebSocket失败: ' + error, 'error');
                setStatus('连接失败', 'error');
            }
        }
        
        function disconnect() {
            if (ws) {
                log('正在断开连接...', 'info');
                ws.close();
            }
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        // 页面加载时设置默认token（如果有）
        window.onload = function() {
            // 如果之前保存了token，自动填充
            const savedToken = localStorage.getItem('jwt_token');
            if (savedToken) {
                document.getElementById('token').value = savedToken;
            }
        };
        
        // 保存token到localStorage
        document.getElementById('token').addEventListener('change', function() {
            localStorage.setItem('jwt_token', this.value);
        });
    </script>
</body>
</html>