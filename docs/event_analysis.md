# AHOP系统事件分析

## 概述
本文档分析了AHOP（Auto Healing Platform）系统中各个功能模块可以产生的事件，包括事件的重要程度、通知对象和实际业务场景。

## 1. 用户认证模块 (Auth)

### 重要事件（高优先级）
| 事件类型 | 事件名称 | 描述 | 通知对象 | 业务场景 |
|---------|---------|------|---------|---------|
| 安全事件 | `auth.login.failed` | 登录失败 | 系统管理员、用户本人 | 连续失败可能是暴力破解攻击 |
| 安全事件 | `auth.login.locked` | 账号被锁定 | 系统管理员、用户本人 | 多次登录失败后账号被锁定 |
| 安全事件 | `auth.login.suspicious` | 异常登录 | 系统管理员、用户本人 | 异地登录、异常时间登录 |
| 审计事件 | `auth.login.success` | 登录成功 | 审计日志 | 正常登录记录 |
| 审计事件 | `auth.logout` | 用户登出 | 审计日志 | 正常登出记录 |
| 权限事件 | `auth.tenant.switch` | 租户切换 | 平台管理员、审计日志 | 平台管理员切换到其他租户 |

### 中等重要事件
| 事件类型 | 事件名称 | 描述 | 通知对象 | 业务场景 |
|---------|---------|------|---------|---------|
| 状态事件 | `auth.token.refresh` | Token刷新 | 审计日志 | 正常的Token刷新操作 |
| 状态事件 | `auth.password.expired` | 密码过期提醒 | 用户本人 | 密码即将过期，需要更换 |

## 2. 用户管理模块 (User)

### 重要事件（高优先级）
| 事件类型 | 事件名称 | 描述 | 通知对象 | 业务场景 |
|---------|---------|------|---------|---------|
| 管理事件 | `user.created` | 用户创建 | 租户管理员、新用户 | 新员工入职，创建账号 |
| 管理事件 | `user.deleted` | 用户删除 | 租户管理员、平台管理员 | 员工离职，删除账号 |
| 安全事件 | `user.password.reset` | 密码重置 | 用户本人、管理员 | 管理员重置用户密码 |
| 状态事件 | `user.status.locked` | 用户锁定 | 用户本人、管理员 | 账号被管理员锁定 |
| 状态事件 | `user.status.deactivated` | 用户停用 | 用户本人、管理员 | 账号被停用 |
| 权限事件 | `user.role.assigned` | 角色分配 | 用户本人、管理员 | 用户被分配新角色 |
| 权限事件 | `user.role.removed` | 角色移除 | 用户本人、管理员 | 用户角色被移除 |

### 中等重要事件
| 事件类型 | 事件名称 | 描述 | 通知对象 | 业务场景 |
|---------|---------|------|---------|---------|
| 管理事件 | `user.updated` | 用户信息更新 | 用户本人 | 个人信息修改 |
| 状态事件 | `user.status.activated` | 用户激活 | 用户本人 | 账号被激活 |

## 3. 租户管理模块 (Tenant)

### 重要事件（高优先级）
| 事件类型 | 事件名称 | 描述 | 通知对象 | 业务场景 |
|---------|---------|------|---------|---------|
| 管理事件 | `tenant.created` | 租户创建 | 平台管理员 | 新客户签约，创建租户 |
| 管理事件 | `tenant.deleted` | 租户删除 | 平台管理员 | 客户解约，删除租户 |
| 状态事件 | `tenant.status.deactivated` | 租户停用 | 平台管理员、租户管理员 | 租户欠费或违规被停用 |
| 计费事件 | `tenant.quota.exceeded` | 配额超限 | 平台管理员、租户管理员 | 资源使用超过限制 |

### 中等重要事件
| 事件类型 | 事件名称 | 描述 | 通知对象 | 业务场景 |
|---------|---------|------|---------|---------|
| 管理事件 | `tenant.updated` | 租户信息更新 | 租户管理员 | 租户基本信息修改 |
| 状态事件 | `tenant.status.activated` | 租户激活 | 租户管理员 | 租户重新激活 |

## 4. 角色权限模块 (Role & Permission)

### 重要事件（高优先级）
| 事件类型 | 事件名称 | 描述 | 通知对象 | 业务场景 |
|---------|---------|------|---------|---------|
| 权限事件 | `role.created` | 角色创建 | 租户管理员 | 创建新的职能角色 |
| 权限事件 | `role.deleted` | 角色删除 | 租户管理员 | 删除不再使用的角色 |
| 权限事件 | `role.permission.assigned` | 权限分配 | 租户管理员、角色用户 | 角色权限变更 |
| 权限事件 | `role.permission.removed` | 权限移除 | 租户管理员、角色用户 | 角色权限收回 |

### 中等重要事件
| 事件类型 | 事件名称 | 描述 | 通知对象 | 业务场景 |
|---------|---------|------|---------|---------|
| 管理事件 | `role.updated` | 角色更新 | 审计日志 | 角色基本信息修改 |

## 5. 凭证管理模块 (Credential)

### 重要事件（高优先级）
| 事件类型 | 事件名称 | 描述 | 通知对象 | 业务场景 |
|---------|---------|------|---------|---------|
| 安全事件 | `credential.created` | 凭证创建 | 创建者、安全管理员 | 添加新的系统凭证 |
| 安全事件 | `credential.deleted` | 凭证删除 | 安全管理员 | 删除不再使用的凭证 |
| 安全事件 | `credential.accessed` | 凭证访问 | 安全管理员 | 凭证被解密使用 |
| 安全事件 | `credential.access.denied` | 凭证访问拒绝 | 安全管理员、访问者 | 非授权访问尝试 |
| 安全事件 | `credential.expired` | 凭证过期 | 凭证管理员 | 凭证已过期需要更新 |
| 安全事件 | `credential.usage.exceeded` | 使用次数超限 | 凭证管理员 | 凭证使用次数达到上限 |

### 中等重要事件
| 事件类型 | 事件名称 | 描述 | 通知对象 | 业务场景 |
|---------|---------|------|---------|---------|
| 管理事件 | `credential.updated` | 凭证更新 | 凭证管理员 | 凭证信息修改 |
| 管理事件 | `credential.tag.updated` | 凭证标签更新 | 审计日志 | 凭证分类管理 |
| 提醒事件 | `credential.expiring` | 凭证即将过期 | 凭证管理员 | 提前提醒更新凭证 |

## 6. 标签管理模块 (Tag)

### 低优先级事件
| 事件类型 | 事件名称 | 描述 | 通知对象 | 业务场景 |
|---------|---------|------|---------|---------|
| 管理事件 | `tag.created` | 标签创建 | 审计日志 | 创建新的分类标签 |
| 管理事件 | `tag.updated` | 标签更新 | 审计日志 | 标签颜色修改 |
| 管理事件 | `tag.deleted` | 标签删除 | 审计日志 | 删除不再使用的标签 |

## 事件重要性分级说明

### 高优先级事件
- **特征**：涉及安全、权限、系统稳定性
- **通知方式**：实时通知（邮件、短信、即时消息）
- **处理要求**：需要立即响应或在短时间内处理

### 中等优先级事件
- **特征**：常规管理操作、状态变更
- **通知方式**：邮件通知、系统内通知
- **处理要求**：可以批量处理或定期处理

### 低优先级事件
- **特征**：辅助功能、元数据管理
- **通知方式**：仅记录日志，可选择性通知
- **处理要求**：仅供审计和追踪使用

## 通知对象角色说明

1. **平台管理员**：负责整个平台的运维和管理
2. **租户管理员**：负责租户内的用户和权限管理
3. **安全管理员**：负责安全相关的配置和监控
4. **凭证管理员**：负责凭证的创建和维护
5. **用户本人**：事件涉及的具体用户
6. **审计日志**：所有事件都应记录到审计日志中

## 实际应用场景示例

### 场景1：新员工入职
1. `tenant.user.created` - 创建用户账号
2. `user.role.assigned` - 分配相应角色
3. `auth.login.success` - 首次登录成功
4. 通知：HR、部门主管、新员工

### 场景2：安全事件响应
1. `auth.login.failed` x 5 - 连续登录失败
2. `user.status.locked` - 账号自动锁定
3. `auth.login.suspicious` - 检测到异常登录
4. 通知：安全管理员、用户本人（通过其他渠道）

### 场景3：凭证管理
1. `credential.expiring` - 凭证即将过期提醒
2. `credential.updated` - 更新凭证信息
3. `credential.accessed` - 凭证被使用
4. 通知：凭证管理员、使用者

### 场景4：权限变更
1. `role.permission.assigned` - 角色添加新权限
2. `user.role.assigned` - 用户获得新角色
3. 通知：受影响的用户、管理员

## 建议的事件处理机制

1. **事件存储**
   - 所有事件都应持久化存储
   - 包含时间戳、操作者、IP地址、详细信息

2. **事件路由**
   - 根据事件类型和重要性进行路由
   - 支持多种通知渠道（邮件、短信、Webhook）

3. **事件聚合**
   - 相似事件的聚合（如连续登录失败）
   - 定期生成事件报告

4. **事件订阅**
   - 允许用户订阅感兴趣的事件
   - 支持细粒度的订阅配置

5. **告警规则**
   - 基于事件频率的告警
   - 基于事件组合的告警
   - 自定义告警阈值